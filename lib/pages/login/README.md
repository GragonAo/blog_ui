# Web3 é’±åŒ…ç™»å½•é›†æˆæŒ‡å—

## åŠŸèƒ½ç‰¹æ€§

âœ¨ **æ”¯æŒçš„é’±åŒ…**
- ğŸ¦Š MetaMaskï¼ˆWeb æµè§ˆå™¨æ‰©å±•ï¼‰
- ğŸ”— WalletConnectï¼ˆç§»åŠ¨ç«¯é’±åŒ…ï¼‰
- æ”¯æŒ Ethereumã€Polygonã€BSC ç­‰ä¸»æµé“¾

ğŸ”’ **å®‰å…¨ç‰¹æ€§**
- æ— éœ€å¯†ç ï¼Œä½¿ç”¨é’±åŒ…ç­¾åè®¤è¯
- é˜²é‡æ”¾æ”»å‡»
- Nonce æ—¶æ•ˆæ€§éªŒè¯
- è‡ªåŠ¨å¤„ç†è´¦æˆ·åˆ‡æ¢

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

åœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼š

```bash
flutter pub get
```

### 2. é…ç½® WalletConnect Project ID

1. è®¿é—® [WalletConnect Cloud](https://cloud.walletconnect.com/)
2. æ³¨å†Œå¹¶åˆ›å»ºæ–°é¡¹ç›®
3. å¤åˆ¶ Project ID
4. åœ¨ `lib/pages/login/controller.dart` ä¸­æ›¿æ¢ï¼š

```dart
projectId: 'YOUR_PROJECT_ID', // æ›¿æ¢ä¸ºä½ çš„ Project ID
```

### 3. é…ç½®åç«¯ API

åœ¨ `lib/http/constants.dart` ä¸­è®¾ç½® API åœ°å€ï¼š

```dart
class HttpString {
  static const String apiBaseUrl = 'https://your-api.com';
}
```

### 4. è¿è¡Œåº”ç”¨

```bash
# Web ç«¯ï¼ˆæ”¯æŒ MetaMaskï¼‰
flutter run -d chrome

# Android/iOSï¼ˆæ”¯æŒ WalletConnectï¼‰
flutter run
```

## ä½¿ç”¨è¯´æ˜

### Web ç«¯ï¼ˆMetaMaskï¼‰

1. **å®‰è£… MetaMask**
   - è®¿é—® [metamask.io](https://metamask.io/)
   - å®‰è£…æµè§ˆå™¨æ‰©å±•
   - åˆ›å»ºæˆ–å¯¼å…¥é’±åŒ…

2. **è¿æ¥é’±åŒ…**
   - æ‰“å¼€åº”ç”¨
   - ç‚¹å‡»"MetaMask"æŒ‰é’®
   - åœ¨å¼¹å‡ºçš„ MetaMask çª—å£ä¸­ç‚¹å‡»"è¿æ¥"
   - ç­¾åæ¶ˆæ¯ä»¥å®Œæˆè®¤è¯

### ç§»åŠ¨ç«¯ï¼ˆWalletConnectï¼‰

1. **å‡†å¤‡ç§»åŠ¨é’±åŒ…**
   - å®‰è£…æ”¯æŒ WalletConnect çš„é’±åŒ…åº”ç”¨
   - æ¨èï¼šTrust Wallet, MetaMask Mobile, Rainbow

2. **è¿æ¥é’±åŒ…**
   - æ‰“å¼€åº”ç”¨
   - ç‚¹å‡»"WalletConnect"æŒ‰é’®
   - æ‰«ææ˜¾ç¤ºçš„äºŒç»´ç 
   - åœ¨é’±åŒ…åº”ç”¨ä¸­ç¡®è®¤è¿æ¥
   - ç­¾åæ¶ˆæ¯ä»¥å®Œæˆè®¤è¯

## é¡¹ç›®ç»“æ„

```
lib/pages/login/
â”œâ”€â”€ controller.dart          # ç™»å½•æ§åˆ¶å™¨ï¼Œå¤„ç†é’±åŒ…è¿æ¥é€»è¾‘
â”œâ”€â”€ view.dart               # ç™»å½•é¡µé¢ UI
â”œâ”€â”€ index.dart              # æ¨¡å—å¯¼å‡º
â”œâ”€â”€ WEB3_API_DOCS.md       # åç«¯ API æ–‡æ¡£
â””â”€â”€ README.md              # æœ¬æ–‡ä»¶

lib/utils/
â””â”€â”€ web3_js_interop.dart   # Web ç«¯ JavaScript äº’æ“ä½œ

web/
â””â”€â”€ index.html             # MetaMask æ£€æµ‹è„šæœ¬
```

## æ ¸å¿ƒåŠŸèƒ½

### LoginPageController

**ä¸»è¦æ–¹æ³•ï¼š**

- `connectMetaMask()` - è¿æ¥ MetaMask é’±åŒ…ï¼ˆWebï¼‰
- `connectWalletConnect()` - è¿æ¥ WalletConnectï¼ˆç§»åŠ¨ç«¯ï¼‰
- `requestSignature(message)` - è¯·æ±‚ç”¨æˆ·ç­¾å
- `disconnect()` - æ–­å¼€é’±åŒ…è¿æ¥

**çŠ¶æ€å˜é‡ï¼š**

- `walletAddress` - å½“å‰è¿æ¥çš„é’±åŒ…åœ°å€
- `isConnecting` - æ˜¯å¦æ­£åœ¨è¿æ¥
- `isConnected` - æ˜¯å¦å·²è¿æ¥

### Web3JsInterop

Web å¹³å°ä¸“ç”¨çš„ JavaScript äº’æ“ä½œç±»ï¼š

- `isMetaMaskAvailable` - æ£€æµ‹ MetaMask æ˜¯å¦å®‰è£…
- `requestAccounts()` - è¯·æ±‚è¿æ¥è´¦æˆ·
- `personalSign()` - è¯·æ±‚ç­¾å
- `onAccountsChanged()` - ç›‘å¬è´¦æˆ·å˜åŒ–
- `onChainChanged()` - ç›‘å¬é“¾åˆ‡æ¢

## è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹æ”¯æŒçš„é“¾

åœ¨ `controller.dart` ä¸­ä¿®æ”¹ï¼š

```dart
final supportedChains = [
  'eip155:1',     // Ethereum Mainnet
  'eip155:137',   // Polygon
  'eip155:56',    // BSC
  'eip155:42161', // Arbitrum
  'eip155:10',    // Optimism
];
```

### è‡ªå®šä¹‰ç­¾åæ¶ˆæ¯

ä¿®æ”¹ `_authenticateWithBackend()` æ–¹æ³•ä¸­çš„æ¶ˆæ¯ï¼š

```dart
final message = 'æ¬¢è¿æ¥åˆ° Blog UIï¼\n'
    'ç­¾åæ­¤æ¶ˆæ¯ä»¥éªŒè¯æ‚¨çš„èº«ä»½\n'
    'æ—¶é—´: $nonce';
```

### ä¿®æ”¹ UI æ ·å¼

åœ¨ `view.dart` ä¸­è‡ªå®šä¹‰ï¼š

- `_buildWalletButton()` - é’±åŒ…æŒ‰é’®æ ·å¼
- `_buildConnectedView()` - å·²è¿æ¥çŠ¶æ€çš„ UI
- `_buildLoginOptions()` - ç™»å½•é€‰é¡¹é¡µé¢

## åç«¯é›†æˆ

### API ç«¯ç‚¹

éœ€è¦å®ç°ä»¥ä¸‹ç«¯ç‚¹ï¼š

```
POST /api/auth/web3-login
```

**è¯·æ±‚ä½“ï¼š**
```json
{
  "address": "0x...",
  "message": "ç­¾åæ¶ˆæ¯...",
  "signature": "0x..."
}
```

**å“åº”ï¼š**
```json
{
  "code": 0,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "userId": "123",
    "address": "0x...",
    "username": "User_1234",
    "token": "jwt_token"
  }
}
```

è¯¦ç»†æ–‡æ¡£è¯·å‚è€ƒ [WEB3_API_DOCS.md](WEB3_API_DOCS.md)

## æµ‹è¯•

### æµ‹è¯•è´¦æˆ·

å¼€å‘ç¯å¢ƒå¯ä»¥ä½¿ç”¨ MetaMask æµ‹è¯•ç½‘ç»œï¼š

1. åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘
2. ä»æ°´é¾™å¤´è·å–æµ‹è¯• ETH
   - [Sepolia Faucet](https://sepoliafaucet.com/)
   - [Alchemy Faucet](https://sepoliafaucet.com/)

### æµ‹è¯•æµç¨‹

1. **è¿æ¥æµ‹è¯•**
   - æµ‹è¯• MetaMask è¿æ¥
   - æµ‹è¯• WalletConnect è¿æ¥
   - éªŒè¯åœ°å€æ˜¾ç¤ºæ­£ç¡®

2. **ç­¾åæµ‹è¯•**
   - è¯·æ±‚ç­¾åå¹¶éªŒè¯
   - æµ‹è¯•ç­¾åå–æ¶ˆçš„å¤„ç†
   - éªŒè¯åç«¯è®¤è¯æµç¨‹

3. **çŠ¶æ€ç®¡ç†æµ‹è¯•**
   - æµ‹è¯•è´¦æˆ·åˆ‡æ¢
   - æµ‹è¯•æ–­å¼€é‡è¿
   - æµ‹è¯•å¤šè®¾å¤‡ç™»å½•

## æ•…éšœæ’é™¤

### MetaMask æœªæ£€æµ‹åˆ°

**é—®é¢˜ï¼š** ç‚¹å‡»è¿æ¥æ— ååº”

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®è®¤å·²å®‰è£… MetaMask æ‰©å±•
2. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯
3. å°è¯•åˆ·æ–°é¡µé¢
4. æ£€æŸ¥ MetaMask æ˜¯å¦å·²è§£é”

### WalletConnect è¿æ¥å¤±è´¥

**é—®é¢˜ï¼š** äºŒç»´ç æ‰«æåæ— æ³•è¿æ¥

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®è®¤å·²é…ç½®æ­£ç¡®çš„ Project ID
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. å°è¯•ä½¿ç”¨å…¶ä»–é’±åŒ…åº”ç”¨
4. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

### ç­¾åå¤±è´¥

**é—®é¢˜ï¼š** ç­¾åè¯·æ±‚è¢«æ‹’ç»

**è§£å†³æ–¹æ¡ˆï¼š**
1. ç¡®ä¿é’±åŒ…æœ‰è¶³å¤Ÿçš„ gasï¼ˆè™½ç„¶ç­¾åä¸éœ€è¦ gasï¼‰
2. æ£€æŸ¥æ¶ˆæ¯æ ¼å¼æ˜¯å¦æ­£ç¡®
3. å°è¯•é‡æ–°è¿æ¥é’±åŒ…

### åç«¯éªŒè¯å¤±è´¥

**é—®é¢˜ï¼š** ç­¾åéªŒè¯è¿”å›é”™è¯¯

**è§£å†³æ–¹æ¡ˆï¼š**
1. æ£€æŸ¥åç«¯ç­¾åéªŒè¯é€»è¾‘
2. ç¡®è®¤æ¶ˆæ¯æ ¼å¼ä¸€è‡´
3. éªŒè¯åœ°å€æ ¼å¼ï¼ˆå¤§å°å†™ï¼‰
4. æ£€æŸ¥ API æ—¥å¿—

## æœ€ä½³å®è·µ

### ç”¨æˆ·ä½“éªŒ

1. **é¦–æ¬¡ä½¿ç”¨å¼•å¯¼**
   - æ˜¾ç¤º"ä»€ä¹ˆæ˜¯ Web3 é’±åŒ…"è¯´æ˜
   - æä¾›å®‰è£…é’±åŒ…çš„é“¾æ¥
   - ç®€åŒ–è¿æ¥æµç¨‹

2. **é”™è¯¯å¤„ç†**
   - å‹å¥½çš„é”™è¯¯æç¤º
   - æä¾›è§£å†³æ–¹æ¡ˆå»ºè®®
   - è®°å½•é”™è¯¯æ—¥å¿—

3. **åŠ è½½çŠ¶æ€**
   - æ˜¾ç¤ºè¿æ¥è¿›åº¦
   - æ˜ç¡®çš„æ“ä½œæŒ‡å¼•
   - è¶…æ—¶å¤„ç†

### å®‰å…¨æ€§

1. **éªŒè¯ç­¾å**
   - å§‹ç»ˆåœ¨åç«¯éªŒè¯ç­¾å
   - æ£€æŸ¥æ¶ˆæ¯å®Œæ•´æ€§
   - é˜²æ­¢é‡æ”¾æ”»å‡»

2. **ä¼šè¯ç®¡ç†**
   - ä½¿ç”¨å®‰å…¨çš„ token
   - è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
   - æ”¯æŒå¤šè®¾å¤‡ç™»å½•

3. **æƒé™æ§åˆ¶**
   - æœ€å°åŒ–è¯·æ±‚çš„æƒé™
   - æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·æƒé™ç”¨é€”
   - æ”¯æŒæƒé™æ’¤é”€

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2026-01-04)
- âœ¨ åˆå§‹ç‰ˆæœ¬
- ğŸ¦Š æ”¯æŒ MetaMaskï¼ˆWebï¼‰
- ğŸ”— æ”¯æŒ WalletConnectï¼ˆç§»åŠ¨ç«¯ï¼‰
- ğŸ”’ å®ç°ç­¾åè®¤è¯
- ğŸ“± å“åº”å¼ UI è®¾è®¡

## è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## è®¸å¯è¯

MIT License

## ç›¸å…³èµ„æº

- [MetaMask æ–‡æ¡£](https://docs.metamask.io/)
- [WalletConnect æ–‡æ¡£](https://docs.walletconnect.com/)
- [Web3dart æ–‡æ¡£](https://pub.dev/packages/web3dart)
- [ä»¥å¤ªåŠå¼€å‘æ–‡æ¡£](https://ethereum.org/zh/developers/)
